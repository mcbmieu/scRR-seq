# ============================================
# Fig. 6 (Part 1): Map and count reads using modified scRepli-seq pipeline
# (original pipeline from https://github.com/kuzobuta/scRepliseq-Pipeline)
# ============================================

# Run in bash

## Step 0.1 Make directory
```
main="scRR_G1_IMR90_hg38"
bash ~/bash Programs/scRepliseq_Pipeline_RPv1/script/scRepliseq/Step0_setup_directories_RPv1.sh ~/$main
```

## Step 0.2  cp fastq data to 'fastq' folder

## Step 1 Step1_Trim_fastq.sh
```
in_dir=~/$main/fastq
out_dir=~/$main/trim_fastq
bash ~/Programs/scRepliseq_Pipeline_RPv1/script/scRepliseq/Step1_Trim_fastq_RPv1.sh $in_dir $out_dir
```

## Step 2 Mapping
```
in_dir=~/$main/trim_fastq
index_file=~/Reference/hg38/hg38.fa.gz # Should be already indexed
genome_name="hg38"
thread=20
out_dir=~/$main/bam

bash ~/Programs/scRepliseq_Pipeline_RPv1/script/scRepliseq/Step2_Mapping_RPv1.sh $in_dir $index_file $genome_name $thread $out_dir
```


## Step 3 Load map reads
# black-list : https://www.encodeproject.org/files/ENCFF356LFX/ ?
# https://stuartlab.org/signac/reference/blacklist_hg38_unified.html
```
bam_dir=~/$main/bam
out_dir=~/$main/Aneu_analysis
blacklist=~/Programs/scRepliseq_Pipeline_RPv1/blacklist/hg38-blacklist.v2.mod.bed
genome_file=~/Reference/hg38/hg38.chrom.sizes.sorted.woMwoAlt
rscript=~/Programs/scRepliseq_Pipeline_RPv1/util/Step3_R-Aneu-Fragment-bins.R

bash ~/Programs/scRepliseq_Pipeline_RPv1/script/scRepliseq/Step3_load_mapped_reads_RPv1.sh $bam_dir $out_dir $blacklist $genome_file $rscript
```


# Step 4 Check MAD scores
### Use version 2 here to remove some abnormal chromosomes ####
### Can specify expected G1 cells

```
rscript=~/Programs/scRepliseq_Pipeline_RPv1/util/Step4_R_MAD_score_RPv2.R
bins_data_dir=~/$main/Aneu_analysis/bins
out_dir=~/$main/Aneu_analysis/MAD_score
out_name="scRR_G1_IMR90_hg38"
G1mad=0.3
Smad=0.8
G1list="IMR-001_1|IMR-003_1|IMR-010_1"
rmchr=""

bash ~/Programs/scRepliseq_Pipeline_RPv1/script/scRepliseq/Step4_MAD_score_QC_RPv2.sh $rscript $bins_data_dir $out_dir $out_name $G1mad $Smad $G1list $rmchr
```


## Step 5.1.1 Check karyotype of G1 cells
```
bin_dir=~/$main/Aneu_analysis/bins
out_dir=~/$main/Aneu_analysis/G1_control
mad_score=~/$main/Aneu_analysis/MAD_score/240726_scRR_G1_IMR90_hg38_MAD_scores_log2_id_rmNA.txt
rscript=~/Programs/scRepliseq_Pipeline_RPv1/util/Step5_R_G1_karyotype_RPv1.R

bash ~/Programs/scRepliseq_Pipeline_RPv1/script/scRepliseq/Step5_1_Check_G1_cells_RPv1.sh $bin_dir $out_dir $mad_score $rscript
```

## Step 5.1.2 Check karyotype of S cells
```
bin_dir=~/$main/Aneu_analysis/bins
out_dir=~/$main/Aneu_analysis/S_phase
mad_score=~/$main/Aneu_analysis/MAD_score/240726_scRR_G1_IMR90_hg38_MAD_scores_log2_id_rmNA.txt
rscript=~/Programs/scRepliseq_Pipeline_RPv1/util/Step5_R_S_karyotype_RPv1.R

bash ~/Programs/scRepliseq_Pipeline_RPv1/script/scRepliseq/Step5_3_Check_S_cells_RPv1.sh $bin_dir $out_dir $mad_score $rscript
```

## Step 5.2 Merged selected of G1 cells
```
rscript=~/Programs/scRepliseq_Pipeline_RPv1/util/Step5_R_Merge_fragment_Rdata.R
out_merged_fragment=~/$main/Aneu_analysis/G1_control/Merged_control_G1_1.fragment.Rdata
dir=~/$main/Aneu_analysis/fragment
list="$dir/IMR-001_1.hg38.clean_srt_markdup_mapq10_blacklist_fragment.Rdata
$dir/IMR-010_1.hg38.clean_srt_markdup_mapq10_blacklist_fragment.Rdata"

bash ~/Programs/scRepliseq_Pipeline_RPv1/script/scRepliseq/Step5_2_Merge_G1_cells_RPv1.sh $rscript $out_merged_fragment $list
```
